#!/usr/bin/env ruby

#
# Config
#
feedsmap = {
	'QC00N000' => {:feed=>1833218449, :key=>'6hPaxYTsoqGA6P9gP3l_mzrpyhCSAKxPeFRlSkpoOW9nND0g', :activation=>'18d3d16130f5a1e85049ed3ada4972a67c1a3c9a'},
	'QC00N001' => {:feed=>1414508960, :key=>'UYqo31CjIWhJi_pItNpcP0X5Mh2SAKwrR3A5MVY4cHZKQT0g', :activation=>'755fae26cae74d6dd643cab5d31a3b62e42c347f'},
    'QC00N002' => {:feed=>1798760718, :key=>'ift2Ri4_rmHmOEMSiTpF3Jzr9TmSAKxtc3lSNmRSMmFYUT0g', :activation=>'251a65806a4da104dc856591ec2e58e4fa3092b2'},
}

#
# Probe
# 
%x{killall spod}

data = %x{spod"}.split(',')

#
# Activate
#
cmd = "curl --request GET http://api.xively.com/v2/devices/#{feedsmap[data[0]][:activation]}/activate"
$stderr.puts cmd
$stderr.puts %x{#{cmd}}

#
# Report
#
if not data.empty? then
	$stderr.puts data


	json = <<-EOF
	{
	  "version":"1.0.0",
	  "datastreams":[
	      {"id":"temperature", "current_value":"#{sprintf '%.2f', data[1]}"},
	      {"id":"humidity",    "current_value":"#{sprintf '%.2f', data[2]}"},
	      {"id":"dewpoint",    "current_value":"#{sprintf '%.2f', data[3]}"}
	  ]
	}
	EOF

	cmd = "curl --request PUT --data '#{json}' --header 'X-ApiKey: #{feedsmap[data[0]][:key]}' http://api.xively.com/v2/feeds/#{feedsmap[data[0]][:feed]}"

	$stderr.puts cmd
	$stderr.puts %x{#{cmd}}

end

